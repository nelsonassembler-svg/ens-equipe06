<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio Equipe 06 - Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --cor-cabecalho: #000080; /* Azul Marinho */
            --cor-texto-cabecalho: #ffffff;
            --cor-borda: #cccccc;
        }

        body {
            font-family: 'Helvetica', Arial, sans-serif;
            background-color: #f4f4f9;
        }

        /* Container Principal */
        .calendario-container {
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-top: 20px;
            margin-bottom: 20px;
            overflow-x: auto; /* Permite rolagem horizontal no celular */
        }

        /* Estiliza√ß√£o da Tabela */
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* For√ßa colunas iguais */
            min-width: 800px; /* Garante largura m√≠nima para n√£o espremer no celular */
        }

        th, td {
            border: 1px solid var(--cor-borda);
            padding: 8px;
            text-align: center;
            vertical-align: top;
            font-size: 14px;
            height: 80px; /* Altura m√≠nima para as c√©lulas de dias */
            word-wrap: break-word;
        }

        /* Cabe√ßalho dos Dias da Semana */
        thead tr:nth-child(2) th {
            background-color: var(--cor-cabecalho);
            color: var(--cor-texto-cabecalho);
            text-transform: uppercase;
            font-size: 12px;
        }

        /* T√≠tulo do M√™s */
        thead tr:first-child th {
            background-color: white;
            color: var(--cor-cabecalho);
            font-size: 24px;
            border: none;
            padding-bottom: 15px;
        }

        /* C√©lulas Edit√°veis */
        td[contenteditable="true"]:hover {
            background-color: #f0f8ff;
            cursor: text;
            outline: 1px solid blue;
        }

        /* Destaque Domingo */
        td:first-child {
            color: #d9534f; /* Vermelho suave */
            font-weight: bold;
        }

        /* --- MODO DE IMPRESS√ÉO (A4) --- */
        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm;
            }
            body {
                background: white;
                margin: 0;
            }
            .no-print {
                display: none !important;
            }
            .calendario-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
                overflow: visible;
            }
            table {
                min-width: 100%;
                font-size: 10pt;
            }
            td {
                height: auto; /* Altura autom√°tica na impress√£o */
            }
        }
    </style>
</head>
<body>

    <div class="container mt-4 no-print">
        <h3 class="text-center mb-4">Gerenciador de Calend√°rio - Equipe 06</h3>
        
        <div class="card p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label class="form-label">Selecione o M√™s (Arquivo CSV):</label>
                    <input type="file" id="fileInput" class="form-control" accept=".csv">
                    <small class="text-muted">Selecione um dos arquivos da sua m√°quina.</small>
                </div>
                
                <div class="col-md-8 text-end">
                    <button class="btn btn-success" onclick="baixarCSV()">
                        üíæ Salvar Altera√ß√µes (Baixar CSV)
                    </button>
                    <button class="btn btn-primary" onclick="window.print()">
                        üñ®Ô∏è Imprimir / Gerar PDF
                    </button>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <strong>Como usar:</strong> Carregue o arquivo, clique em qualquer c√©lula para editar o texto. 
            Para salvar, clique em "Baixar CSV". Para gerar o PDF A4, clique em "Imprimir".
        </div>
    </div>

    <div class="container calendario-container" id="areaImpressao">
        <table id="tabelaCalendario">
            <thead>
                </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        let nomeArquivoAtual = "calendario_editado.csv";

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            nomeArquivoAtual = file.name;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                processarCSV(text);
            };
            
            reader.readAsText(file, 'UTF-8'); // Tenta UTF-8
        });

        function processarCSV(csvText) {
            const linhas = csvText.split('\n');
            const tabelaHead = document.querySelector('#tabelaCalendario thead');
            const tabelaBody = document.querySelector('#tabelaCalendario tbody');
            
            tabelaHead.innerHTML = '';
            tabelaBody.innerHTML = '';

            // Assumindo a estrutura padr√£o dos seus arquivos:
            // Linha 0: Nome do M√™s
            // Linha 1: Dias da Semana
            // Linha 2+: Dados

            // 1. T√≠tulo do M√™s
            let colunas = 7; 
            let linhaMes = linhas[0].split(',')[0].replace(/"/g, ''); // Pega s√≥ o primeiro item
            
            let trTitulo = document.createElement('tr');
            let thTitulo = document.createElement('th');
            thTitulo.colSpan = colunas;
            thTitulo.textContent = linhaMes;
            trTitulo.appendChild(thTitulo);
            tabelaHead.appendChild(trTitulo);

            // 2. Dias da Semana
            let trDias = document.createElement('tr');
            // Hardcoded para garantir formata√ß√£o correta, ou ler da linha 1
            const diasSemana = ["DOMINGO", "SEGUNDA", "TER√áA", "QUARTA", "QUINTA", "SEXTA", "S√ÅBADO"];
            
            diasSemana.forEach(dia => {
                let th = document.createElement('th');
                th.textContent = dia;
                trDias.appendChild(th);
            });
            tabelaHead.appendChild(trDias);

            // 3. Dados (Dias e Eventos)
            // Come√ßa da linha 2 (√≠ndice 2) pois pulamos t√≠tulo e cabe√ßalho original
            for (let i = 2; i < linhas.length; i++) {
                if (linhas[i].trim() === '') continue;

                let celulas = parseCSVLine(linhas[i]);
                
                // Garante que tem 7 colunas
                while(celulas.length < 7) celulas.push("");

                let tr = document.createElement('tr');
                
                celulas.forEach((celulaTexto, index) => {
                    if (index >= 7) return; // Ignora colunas extras
                    
                    let td = document.createElement('td');
                    td.contentEditable = "true"; // TORNA EDIT√ÅVEL
                    td.textContent = celulaTexto.replace(/"/g, ''); // Remove aspas extras do CSV
                    tr.appendChild(td);
                });
                
                tabelaBody.appendChild(tr);
            }
        }

        // Fun√ß√£o auxiliar para ler linha CSV respeitando aspas
        function parseCSVLine(text) {
            let re_valid = /^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;
            let re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
            
            let a = [];
            text.replace(re_value, function(m0, m1, m2, m3) {
                if      (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
                else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
                else if (m3 !== undefined) a.push(m3);
                return '';
            });
            
            if (/,\s*$/.test(text)) a.push('');
            return a;
        }

        function baixarCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // 1. T√≠tulo
            const titulo = document.querySelector('#tabelaCalendario thead tr:first-child th').textContent;
            csvContent += titulo + ",,,,,,\n";
            
            // 2. Cabe√ßalho
            csvContent += "DOMINGO,SEGUNDA,TER√áA,QUARTA,QUINTA,SEXTA,S√ÅBADO\n";

            // 3. Dados
            const linhas = document.querySelectorAll('#tabelaCalendario tbody tr');
            linhas.forEach(linha => {
                let rowData = [];
                const cols = linha.querySelectorAll('td');
                cols.forEach(col => {
                    // Adiciona aspas se tiver v√≠rgula no texto para n√£o quebrar o CSV
                    let texto = col.textContent;
                    if (texto.includes(',')) {
                        texto = `"${texto}"`;
                    }
                    rowData.push(texto);
                });
                csvContent += rowData.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Editado_" + nomeArquivoAtual);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
